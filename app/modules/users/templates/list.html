<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Zarządzanie zespołem - Wood Power CRM</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app-container">
        {% include 'sidebar/sidebar.html' %}
        <main class="main-content">

            <h1 class="title-with-underline">Zarządzanie zespołem</h1>

            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Sekcja: Dodaj nowego użytkownika -->
            <div class="add-new-user">
                <h2 class="title-with-underline-h2">Dodaj nowego użytkownika</h2>

                <div class="add-new-user-box">
                    <form action="{{ url_for('users.invite_user') }}" method="post" class="inputs-new-user">
                        
                        <!-- Rola -->
                        <div class="role-input">
                            <label class="input-txt" for="invite_role">Rola:</label>
                            <div class="input-new-user">
                                <select name="invite_role" id="invite_role" class="select-role">
                                    <option value="user" selected>user</option>
                                    <option value="admin">admin</option>
                                    <option value="partner">partner</option>
                                </select>
                            </div>
                        </div>

                        <!-- Mnożnik partnera (pokazuje się tylko dla roli partner) -->
                        <div class="multiplier-select" id="inviteMultiplierRow" style="display: none;">
                            <label class="input-txt" for="invite_multiplier">Mnożnik partnera:</label>
                            <div class="input-new-user">
                                <select name="invite_multiplier" id="invite_multiplier" class="select-role">
                                    {% for m in multipliers %}
                                    <option value="{{ m.id }}">{{ m.client_type }} ({{ m.multiplier }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="email-input">
                            <label class="input-txt" for="invite_email">E-mail:</label>
                            <div class="input-new-user">
                                <input type="email" id="invite_email" name="invite_email" class="plain-input" required>
                            </div>
                        </div>

                        <!-- Przycisk submit -->
                        <button type="submit" class="orange-button">Wyślij zaproszenie</button>
                    </form>
                </div>
            </div>

            <!-- Sekcja: Lista użytkowników -->
            <div class="user-list">
                <h2 class="title-txt title-with-underline-h2">Lista użytkowników</h2>

                <!-- Nagłówki tabeli -->
                <div class="headers">
                    <div class="header-txt" style="width:50px;">Avatar</div>
                    <div class="header-txt" style="width:150px;">Imię i nazwisko</div>
                    <div class="header-txt" style="width:250px;">Adres e-mail</div>
                    <div class="header-txt" style="width:100px;">Uprawnienia</div>
                    <div class="header-txt" style="width:50px;">Akcje</div>
                </div>

                <!-- Lista użytkowników -->
                <div class="list">
                    {% for u in users_list %}
                    <div class="user-row">
                        <!-- Avatar -->
                        <div class="avatar-box" style="width:50px;">
                            <img src="{{ u.avatar_path or url_for('static', filename='images/avatars/default_avatars/avatar1.svg') }}"
                                 alt="avatar"
                                 style="width: 32px; height: 32px; border-radius: 50%;">
                        </div>

                        <!-- Imię i nazwisko -->
                        <div class="data-txt" style="width:150px;">
                            {{ u.first_name }} {{ u.last_name }}
                        </div>

                        <!-- Email -->
                        <div class="data-txt" style="width:250px;">{{ u.email }}</div>

                        <!-- Rola -->
                        <div class="data-txt" style="width:100px;">{{ u.role }}</div>

                        <!-- Akcje -->
                        <div class="actions" style="width:50px;">
                            <!-- Przycisk Edytuj -->
                            <button type="button"
                                    class="orange-button open-edit-modal"
                                    data-user-id="{{ u.id }}"
                                    data-first-name="{{ u.first_name }}"
                                    data-last-name="{{ u.last_name }}"
                                    data-role="{{ u.role }}"
                                    data-email="{{ u.email }}">
                                Edytuj
                            </button>

                            <!-- Aktywuj/Dezaktywuj -->
                            {% if u.active %}
                            <form action="{{ url_for('users.deactivate_user', user_id=u.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Na pewno dezaktywować?');">
                                <button type="submit" class="modify-button modify-button--black">Dezaktywuj</button>
                            </form>
                            {% else %}
                            <form action="{{ url_for('users.activate_user', user_id=u.id) }}" method="post" style="display:inline;">
                                <button type="submit" class="modify-button modify-button--green">Aktywuj</button>
                            </form>
                            {% endif %}

                            <!-- Usuń -->
                            <form action="{{ url_for('users.delete_user', user_id=u.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Czy na pewno chcesz usunąć użytkownika?');">
                                <button type="submit" class="delete-button">Usuń</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </main>
    </div>

    <!-- Modal edycji użytkownika -->
    <div class="modal-overlay" id="modal-overlay" style="display: none;"></div>

    <div class="modal-box" id="editModal" style="display: none;">
        <button class="close-modal" id="closeModalBtn">X</button>
        <h2 class="title-txt title-with-underline-h2">Edycja użytkownika</h2>

        <form action="{{ url_for('users.edit_user', user_id=0) }}" method="post" id="editUserForm">
            <input type="hidden" name="user_id" id="editUserId">

            <div class="modal-input-row">
                <label for="editFirstName">Imię:</label>
                <input type="text" name="first_name" id="editFirstName" class="plain-input" required>
            </div>

            <div class="modal-input-row">
                <label for="editLastName">Nazwisko:</label>
                <input type="text" name="last_name" id="editLastName" class="plain-input" required>
            </div>

            <div class="modal-input-row">
                <label for="editRole">Rola:</label>
                <select name="role" id="editRole" class="plain-input">
                    <option value="user">user</option>
                    <option value="admin">admin</option>
                    <option value="partner">partner</option>
                </select>
            </div>

            <div class="modal-input-row">
                <label for="editEmail">E-mail:</label>
                <input type="email" name="email" id="editEmail" class="plain-input" required>
            </div>

            <div class="modal-actions">
                <button type="submit" class="edit-button">Zapisz</button>
                <button type="button" class="modify-button modify-button--black" id="cancelModalBtn">Anuluj</button>
            </div>
        </form>
    </div>

    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Pokazuj/ukrywaj mnożnik partnera przy zaproszeniu
        document.getElementById('invite_role').addEventListener('change', function() {
            const multiplierRow = document.getElementById('inviteMultiplierRow');
            if (this.value === 'partner') {
                multiplierRow.style.display = 'block';
            } else {
                multiplierRow.style.display = 'none';
            }
        });

        // Modal edycji użytkownika
        document.querySelectorAll('.open-edit-modal').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const firstName = this.dataset.firstName;
                const lastName = this.dataset.lastName;
                const role = this.dataset.role;
                const email = this.dataset.email;

                document.getElementById('editUserId').value = userId;
                document.getElementById('editFirstName').value = firstName;
                document.getElementById('editLastName').value = lastName;
                document.getElementById('editRole').value = role;
                document.getElementById('editEmail').value = email;

                // Aktualizuj action formularza
                document.getElementById('editUserForm').action = `/users/${userId}/edit`;

                document.getElementById('modal-overlay').style.display = 'block';
                document.getElementById('editModal').style.display = 'block';
            });
        });

        // Zamknij modal
        document.getElementById('closeModalBtn').addEventListener('click', function() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('cancelModalBtn').addEventListener('click', function() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
        });
    </script>
</body>
</html>